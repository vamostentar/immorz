// Schema do properties-service - Gestão de Imóveis
// Este serviço NÃO armazena dados de utilizadores
// Utiliza apenas referências externas (IDs do auth-service)
// Dados de utilizador são enriquecidos pelo API Gateway quando necessário

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// === ENUMERAÇÕES ===

enum PropertyStatus {
  for_sale
  for_rent
  sold
  rented
  under_contract
  withdrawn
}

enum AdminStatus {
  ACTIVE
  PENDING
  INACTIVE
}

enum PropertyType {
  apartamento
  moradia
  loft
  penthouse
  estudio
  escritorio
  terreno
  loja
  armazem
  quinta
  predio
}

enum PropertyFeature {
  POOL
  GARAGE
  GARDEN
  ELEVATOR
  BALCONY
  TERRACE
  FIREPLACE
  AIR_CONDITIONING
  CENTRAL_HEATING
  SOLAR_PANELS
  FURNISHED
  PARKING
  SECURITY_SYSTEM
  GYM
  SPA
  CONCIERGE
  PET_FRIENDLY
  OCEAN_VIEW
  MOUNTAIN_VIEW
  CITY_VIEW
}

// === MODELOS ===

// Imóvel - Modelo principal
model Property {
  id          String   @id @default(uuid())
  title       String   @db.VarChar(200)
  location    String   @db.VarChar(500)
  price       Decimal  @db.Decimal(12, 2)
  status      PropertyStatus @default(for_sale)
  adminStatus AdminStatus @default(ACTIVE)
  type        PropertyType?
  imageUrl    String?  @db.VarChar(2048)
  description String?  @db.Text
  
  // Características do imóvel
  bedrooms    Int?     @db.SmallInt
  bathrooms   Int?     @db.SmallInt  
  area        Decimal? @db.Decimal(8, 2) // em metros quadrados
  yearBuilt   Int?     @db.SmallInt
  
  // Dados de localização
  coordinates Json? // { latitude: number, longitude: number }

  // Características adicionais
  garage       Boolean? @default(false)
  pool         Boolean? @default(false)
  energyRating String?  @db.VarChar(5) // A+, A, B, C, D, E, F
  
  // Características e comodidades
  features    String[] @default([])
  
  // Informação de contacto
  contactPhone String? @db.VarChar(20)
  contactEmail String? @db.VarChar(100)
  
  // Referências externas (IDs do auth-service)
  // NOTA: Não há relações FK - os dados são enriquecidos pelo API Gateway
  ownerId     String?  // ID do proprietário (auth-service)
  agentId     String?  // ID do agente responsável (auth-service)
  createdBy   String?  // ID de quem criou o registo (auth-service)
  updatedBy   String?  // ID de quem actualizou (auth-service)
  
  // Metadados
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos internos do serviço
  images       PropertyImage[]
  visits       PropertyVisit[]
  favorites    PropertyFavorite[]
  priceHistory PriceHistory[]
  
  // Índices para pesquisa eficiente
  @@index([status])
  @@index([adminStatus])
  @@index([type])
  @@index([price])
  @@index([area])
  @@index([bedrooms])
  @@index([bathrooms])
  @@index([yearBuilt])
  @@index([location])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([status, type])
  @@index([status, price])
  @@index([type, price])
  @@index([adminStatus, status])
  @@index([ownerId])
  @@index([agentId])
  
  @@map("properties")
}

// Imagens do imóvel
model PropertyImage {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  url        String   @db.VarChar(2048)
  alt        String?  @db.VarChar(200)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  
  @@index([propertyId, order])
  @@map("property_images")
}

// Histórico de preços
model PriceHistory {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  oldPrice   Decimal? @db.Decimal(12, 2)
  newPrice   Decimal  @db.Decimal(12, 2)
  reason     String?  @db.VarChar(100)
  changedAt  DateTime @default(now())
  changedBy  String?  // ID do utilizador que fez a alteração (auth-service)
  
  @@index([propertyId, changedAt])
  @@map("price_history")
}

// Visitas ao imóvel (analytics)
model PropertyVisit {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  visitorId  String?  // ID do utilizador se autenticado (auth-service)
  ipAddress  String   @db.Inet
  userAgent  String?  @db.Text
  visitedAt  DateTime @default(now())
  
  @@index([propertyId, visitedAt])
  @@index([visitorId, visitedAt])
  @@map("property_visits")
}

// Favoritos de imóveis
model PropertyFavorite {
  id         String   @id @default(uuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  userId     String   // ID do utilizador (auth-service)
  createdAt  DateTime @default(now())
  
  @@unique([propertyId, userId])
  @@index([userId, createdAt])
  @@map("property_favorites")
}

// Configurações do serviço
model PropertySettings {
  id                    String @id @default("singleton")
  
  // Limites de listagem
  maxImagesPerProperty  Int    @default(20)
  maxFeaturesPerProperty Int   @default(15)
  
  // Valores por defeito
  defaultCurrency       String @default("EUR")
  defaultStatus         PropertyStatus @default(for_sale)
  
  // Validações
  minPrice              Decimal? @db.Decimal(12, 2)
  maxPrice              Decimal? @db.Decimal(12, 2)
  minArea               Decimal? @db.Decimal(8, 2)
  maxArea               Decimal? @db.Decimal(8, 2)
  
  // Metadados
  updatedAt DateTime @updatedAt
  updatedBy String?  // ID do utilizador que actualizou (auth-service)
  
  @@map("property_settings")
}