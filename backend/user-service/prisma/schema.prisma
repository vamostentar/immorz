// Schema do user-service - Perfil Estendido do Utilizador
// Este serviço NÃO duplica dados de autenticação (email, password, role)
// Esses dados são geridos pelo auth-service
// O ID do UserProfile é o MESMO ID do User no auth-service

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Perfil do Utilizador - Dados estendidos que complementam o auth-service
model UserProfile {
  id        String   @id // Mesmo ID do auth-service (não auto-gerado)
  
  // Dados de perfil (NÃO duplicados do auth)
  bio       String?  // Biografia pessoal
  avatar    String?  // URL para imagem de avatar
  dateOfBirth DateTime?
  gender    Gender?
  
  // Informação de endereço
  address    String?
  city       String?
  state      String?
  country    String?
  postalCode String?
  
  // Preferências de contacto e idioma
  preferredContactMethod ContactMethod @default(EMAIL)
  language              String        @default("pt")
  timezone              String        @default("Europe/Lisbon")
  
  // Definições de privacidade
  profileVisibility  ProfileVisibility @default(PUBLIC)
  allowMarketing     Boolean           @default(false)
  allowNotifications Boolean           @default(true)
  
  // Relacionamentos com outras entidades deste serviço
  propertyInterests PropertyInterest[]
  savedProperties   SavedProperty[]
  searchHistory     SearchHistory[]
  notifications     Notification[]
  preferences       UserPreferences?
  
  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("user_profiles")
}

// Preferências detalhadas do utilizador para pesquisa de imóveis
model UserPreferences {
  id          String @id @default(cuid())
  userId      String @unique
  user        UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Preferências de tipo de imóvel
  propertyTypes     PropertyType[]
  minPrice          Decimal?
  maxPrice          Decimal?
  minBedrooms       Int?
  maxBedrooms       Int?
  minBathrooms      Int?
  maxBathrooms      Int?
  minArea           Decimal?
  maxArea           Decimal?
  preferredLocation String?
  
  // Preferências de pesquisa
  searchRadius      Int?     @default(10) // km
  sortBy            SortBy   @default(RELEVANCE)
  viewMode          ViewMode @default(LIST)
  
  // Preferências de notificações
  emailNotifications     Boolean @default(true)
  smsNotifications       Boolean @default(false)
  pushNotifications      Boolean @default(true)
  priceDropAlerts        Boolean @default(true)
  newPropertyAlerts      Boolean @default(true)
  marketUpdateAlerts     Boolean @default(false)
  
  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("user_preferences")
}

// Interesse em imóveis específicos
model PropertyInterest {
  id         String @id @default(cuid())
  userId     String
  user       UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Referência externa ao imóvel (ID do properties-service)
  propertyId String
  
  // Detalhes do interesse
  interestType InterestType @default(VIEW)
  notes        String?
  priority     Priority     @default(MEDIUM)
  
  // Estado
  isActive     Boolean @default(true)
  contacted    Boolean @default(false)
  contactedAt  DateTime?
  
  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, propertyId])
  @@map("property_interests")
}

// Imóveis guardados/favoritos
model SavedProperty {
  id         String @id @default(cuid())
  userId     String
  user       UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Referência externa ao imóvel (ID do properties-service)
  propertyId String
  
  // Detalhes de organização
  folder     String?   // Pasta personalizada
  notes      String?   // Notas do utilizador
  tags       String[]  // Etiquetas definidas pelo utilizador
  
  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, propertyId])
  @@map("saved_properties")
}

// Histórico de pesquisas
model SearchHistory {
  id     String @id @default(cuid())
  userId String
  user   UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Parâmetros de pesquisa
  query        String?
  location     String?
  propertyType PropertyType[]
  minPrice     Decimal?
  maxPrice     Decimal?
  minBedrooms  Int?
  maxBedrooms  Int?
  minBathrooms Int?
  maxBathrooms Int?
  minArea      Decimal?
  maxArea      Decimal?
  
  // Metadados da pesquisa
  resultsCount Int?  // Número de resultados
  searchTime   Int?  // Tempo em milissegundos
  
  // Metadados
  createdAt DateTime @default(now())
  
  @@map("search_history")
}

// Notificações do utilizador
model Notification {
  id     String @id @default(cuid())
  userId String
  user   UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Detalhes da notificação
  type        NotificationType
  title       String
  message     String
  data        Json? // Dados adicionais em JSON
  
  // Estado
  isRead      Boolean   @default(false)
  readAt      DateTime?
  isArchived  Boolean   @default(false)
  archivedAt  DateTime?
  
  // Entrega
  deliveryMethod DeliveryMethod @default(IN_APP)
  sentAt         DateTime?
  deliveredAt    DateTime?
  
  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("notifications")
}

// === ENUMERAÇÕES ===

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum ContactMethod {
  EMAIL
  PHONE
  SMS
  WHATSAPP
}

enum ProfileVisibility {
  PUBLIC
  PRIVATE
  FRIENDS_ONLY
}

enum PropertyType {
  APARTMENT
  HOUSE
  TOWNHOUSE
  CONDO
  STUDIO
  LOFT
  PENTHOUSE
  VILLA
  COMMERCIAL
  LAND
  OTHER
}

enum InterestType {
  VIEW
  INQUIRY
  SCHEDULE_VISIT
  MAKE_OFFER
  FAVORITE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SortBy {
  RELEVANCE
  PRICE_ASC
  PRICE_DESC
  DATE_ASC
  DATE_DESC
  AREA_ASC
  AREA_DESC
}

enum ViewMode {
  LIST
  GRID
  MAP
}

enum NotificationType {
  PROPERTY_ALERT
  PRICE_DROP
  NEW_PROPERTY
  MARKET_UPDATE
  SYSTEM_ANNOUNCEMENT
  REMINDER
  WELCOME
}

enum DeliveryMethod {
  IN_APP
  EMAIL
  SMS
  PUSH
}
