# Docker Compose - Development Overrides
# Ribeira Azul - Real Estate Platform
# 
# Este arquivo sobrescreve as configurações de produção para desenvolvimento local
# Uso: docker-compose -f docker-compose.yaml -f docker-compose.dev.yml up

x-dev-environment: &dev-env
  NODE_ENV: development
  LOG_LEVEL: debug

services:
  # ====================================
  # Database - Development Settings
  # ====================================
  db:
    ports:
      - "5432:5432"  # Expor porta para ferramentas como DBeaver, pgAdmin
    environment:
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.utf8"
    healthcheck:
      interval: 10s  # Mais frequente em dev para acelerar startup
      timeout: 5s
      start_period: 10s

  # ====================================
  # Redis - Development Settings
  # ====================================
  redis:
    ports:
      - "6379:6379"  # Expor porta para Redis CLI/GUI
    command: [
      "redis-server",
      "--requirepass", "${REDIS_PASSWORD}",
      "--maxmemory", "256mb",
      "--maxmemory-policy", "allkeys-lru",
      "--appendonly", "no"  # Desabilitar persistência em dev para melhor performance
    ]
    healthcheck:
      interval: 10s
      timeout: 5s

  # ====================================
  # MinIO - Development Settings
  # ====================================
  minio:
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console Web UI
    healthcheck:
      interval: 10s
      timeout: 5s

  # ====================================
  # Auth Service - Development Settings
  # ====================================
  auth:
    build:
      context: ./backend/auth-service
      dockerfile: Dockerfile
      target: development  # Se tiver multi-stage build
    volumes:
      - ./backend/auth-service/src:/app/src:cached  # Hot reload
      - /app/node_modules  # Prevent overwriting node_modules
    environment:
      <<: *dev-env
      DEBUG: auth:*
      CORS_ORIGINS: http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:5174
      CORS_ORIGIN: http://localhost:3000,http://localhost:3001
      API_URL: http://localhost:3000
    healthcheck:
      interval: 10s
      start_period: 30s

  # ====================================
  # Properties Service - Development
  # ====================================
  properties:
    build:
      context: ./backend/properties-service
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./backend/properties-service/src:/app/src:cached
      - /app/node_modules
    environment:
      <<: *dev-env
      DEBUG: properties:*
      BASE_URL: http://localhost:3000
      CORS_ORIGINS: http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:5174
      CORS_ORIGIN: http://localhost:3000,http://localhost:3001
    healthcheck:
      interval: 10s
      start_period: 30s

  # ====================================
  # Users Service - Development
  # ====================================
  users:
    build:
      context: ./backend/user-service
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./backend/user-service/src:/app/src:cached
      - /app/node_modules
    environment:
      <<: *dev-env
      DEBUG: users:*
      CORS_ORIGINS: http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:5174
      CORS_ORIGIN: http://localhost:3000,http://localhost:3001
      API_URL: http://localhost:3000
    healthcheck:
      interval: 10s
      start_period: 30s

  # ====================================
  # Settings Service - Development
  # ====================================
  settings:
    build:
      context: ./backend/settings-service
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./backend/settings-service/src:/app/src:cached
      - /app/node_modules
    environment:
      <<: *dev-env
      DEBUG: settings:*
      CORS_ORIGINS: http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:5174
      CORS_ORIGIN: http://localhost:3000,http://localhost:3001
      API_URL: http://localhost:3000
    healthcheck:
      interval: 10s
      start_period: 30s

  # ====================================
  # Media Service - Development
  # ====================================
  media:
    build:
      context: ./backend/media-service
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./backend/media-service/src:/app/src:cached
      - /app/node_modules
    environment:
      <<: *dev-env
      DEBUG: media:*
      CORS_ORIGINS: http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:5174
      CORS_ORIGIN: http://localhost:3000,http://localhost:3001
      API_URL: http://localhost:3000
    healthcheck:
      interval: 10s
      start_period: 30s

  # ====================================
  # Messages Service - Development
  # ====================================
  messages:
    build:
      context: ./backend/messages-service
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./backend/messages-service/src:/app/src:cached
      - /app/node_modules
    environment:
      <<: *dev-env
      DEBUG: messages:*
    healthcheck:
      interval: 10s
      start_period: 30s

  # ====================================
  # API Gateway - Development
  # ====================================
  api-gateway:
    build:
      context: ./backend/api-gateway
      dockerfile: Dockerfile
      target: development
    ports:
      - "8081:8081"  # Expor API Gateway
      - "9229:9229"  # Node.js debugger
    volumes:
      - ./backend/api-gateway/src:/app/src:cached
      - /app/node_modules
    environment:
      <<: *dev-env
      DEBUG: gateway:*
      CORS_ORIGINS: http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:5174
      CORS_ORIGIN: http://localhost:3000,http://localhost:3001
    healthcheck:
      interval: 10s
      start_period: 30s

  # ====================================
  # Frontend - Development
  # ====================================
  web:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev  # Usar Dockerfile de desenvolvimento
      args:
        NODE_ENV: development
    ports:
      - "3000:80"     # Frontend porta 3000
      - "5173:5173"   # Vite dev server (se usar Vite)
    volumes:
      - ./frontend/src:/app/src:cached
      - ./frontend/public:/app/public:cached
      - /app/node_modules
    environment:
      NODE_ENV: development
      VITE_API_URL: http://localhost:8081
    command: npm run dev  # Ou yarn dev
    healthcheck:
      interval: 10s
      start_period: 20s
